---
title: "おかね"
free: true
---

# 概要
今回登場した(監視に係る)コンポーネントたちのお金をまとめていきます。(2023/01/07基準)

結論からいうと、本当に運用に必要なログをCloudwatch に流そうね、というだけ。

# おかね
## FireLens
FireLensそのものに費用はかからない。  
ただし、Cloudwatch Logsにログ送るときは`PutLogEvent`で送ってるし、Kinesisに送るときもそっちで課金されるので要注意。特にCloudwatch Logsは高いぞ。

## CloudWatch
今回の主役。[お値段も主役](https://aws.amazon.com/jp/cloudwatch/pricing/)。

### Logs
|内容|料金|
|----------------------------------------|---------------|
|データ収集         |1GB/$0.76|
|アーカイブ・ストア   |1GB/$0.033|
|Insightsによる解析 |1GB/$0.0076|

収集が特に高価であることに留意。塵も積もれば山となる。

### Metrics
基本的に24時間1時間以上止めずにカスタムメトリクスを送った場合の料金であり、エラー通知のメトリクスなどでは安価になる点に留意。

カーディナリティに注意してカスタムメトリクスを作る分にはそこまでの費用にならないはず。

|内容|料金|
|----------------------------------------|---------------|
|最初の10000メトリクス   |1メトリクス/$0.30|
|次の240000メトリクス   |1メトリクス/$0.10|

## Dashboard
無料は3つまで。4つ目から3ドルかかります。

(ダッシュボード複数個も運用できてるならこんな本読んでない気がしますね。作り過ぎに注意してください)

# Alerm
|内容|料金|
|----------------------------------------|---------------|
|標準解像度(1分間隔のメトリクス)10個まで   | 無料枠|
|標準解像度(1分間隔のメトリクス)11個から   | $0.1|
|高解像度(1分未満のメトリクス)   |$0.30|

## Kinesis
アプリケーションから送られたログを圧縮してS3に保存してくれる用途で利用。

[Amazon Kinesis Data Firehose](https://aws.amazon.com/jp/kinesis/data-firehose/pricing/)より、

|内容|料金|
|----------------------------------------|---------------|
|DirectPUTからの取り込み 最初の500TB/月   | $0.036|

ログファイルごときではPBの領域には踏み込まないだろうということでこれだけしかかからない。

## S3
AWSでは毎度おなじみ[S3](https://aws.amazon.com/jp/s3/pricing/)。

|内容|料金|
|----------------------------------------|---------------|
|S3 標準 最初の 50 TB/月 | 1GB/$0.025|
|S3 Glacier Instant Retrieval  | 1GB/$0.005 |

アクセス頻度によって保存するタイプを変えられる。一番不便な`S3 Glacier Deep Archive`ともなれば$0.002まで圧縮できる。  
S3に保存するデータの性質にあわせてあったものを選ぶべき。

標準でもCloudwatch よりは安い。

## Athena
S3に保存したログを検索するために利用。料金は[こちら](https://aws.amazon.com/jp/athena/pricing/?nc=sn&loc=3)より。

|内容|料金|
|----------------------------------------|---------------|
|SQLクエリでスキャンした対象データ| 1TB/$5.00|

なかなかTBのデータをスキャンすることはないと思うが、パーティションを何も考えず、ばかすかデータをS3にためていると危険。  
なお、スキャンする対象データがS3上にある場合、gzipしていればそのサイズで計算されるのでそうかんたんにTBを検索することはできないはず。

ぱっとみCloudwatch Insightsのほうが安く見えるが、実際は`$0.0076*1024≒$7.8`なので、1TBあたりで見るとAthenaのほうが安い。

# example.
自分が本業で扱っているAPI(プライベートクラウド)を基準に料金を計算してみる。

## 出力されるログ
- アプリケーションログ(1日あたり 250MB * 8台 -> 1ヶ月:60GB)
- アクセスログ(1日あたり 650MB * 8台 -> 1ヶ月:156GB)

### Cloudwatchに適当に突っ込んだ試算

|内容|料金|合計|
|------------------|----------|---|
|データ収集          |1GB/$0.76|  $0.76 * 216GB =  $164.16
|アーカイブ・ストア   |1GB/$0.033| $0.033 * 216GB = $7.12800

アーカイブは保存期間によって増えていく。上記の例が半年続いたとすれば、一月ごとにアーカイブの料金は$7ずつ増加していく計算。収集は初回のみである。

### アクセスログを全部S3に投げた試算

|内容|料金|合計|
|------------------|----------|---|
|データ収集          |1GB/$0.76|  $0.76 * 60GB =  $45.6
|アーカイブ・ストア   |1GB/$0.033| $0.033 * 60GB = $1.98
|(S3) 標準          |1GB/$0.025| $0.025 * 156GB = $3.9
|Kinesis           |500TB/$0.036 | $0.036

となる。  
Cloudwatchのデータ収集を避けるだけでコスト圧縮できるというのがポイント。(運用に必要なログだけをCloudwatchに流せるログ設計を心がけること) 

## 節約のポイント
- CloudWatch Logsの保存期間を最小限度にすること
- S3に入れるデータはアクセス頻度に応じて安いストレージを採用すること
- S3に入れるデータも保存期間に留意すること
- 運用に必要なログだけをCloudwatchにいれること
- 有効なメトリクスだけをアラートに採用すること
- カスタムメトリクスはディメンションのカーディナリティに最大限注意すること
- S3に入れるファイルは圧縮すること(検索が多少遅くなるデメリットはあります)